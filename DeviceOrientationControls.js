var DeviceOrientationController=function(object,domElement,options){this.object=object,this.element=domElement||document,this.freeze=!0,this.enableManualDrag=!0,this.enableManualZoom=!0,this.useQuaternions=!0,this.deviceOrientation={},this.screenOrientation=window.orientation||0;var scrollSpeedX,scrollSpeedY,tmpFOV,relativeFOVFrustrumHeight,relativeVerticalFOV,startX=0,startY=0,currentX=0,currentY=0,tmpQuat=new THREE.Quaternion,zoomStart=1,zoomCurrent=1,zoomP1=new THREE.Vector2,zoomP2=new THREE.Vector2,CONTROLLER_STATE={AUTO:0,MANUAL_ROTATE:1,MANUAL_ZOOM:2},appState=CONTROLLER_STATE.AUTO,CONTROLLER_EVENT={CALIBRATE_COMPASS:"compassneedscalibration",SCREEN_ORIENTATION:"orientationchange",MANUAL_CONTROL:"userinteraction",ZOOM_CONTROL:"zoom",ROTATE_CONTROL:"rotate"},startClientHeight=window.innerHeight,startFOVFrustrumHeight=2e3*Math.tan(THREE.Math.degToRad((this.object.fov||75)/2)),deviceQuat=new THREE.Quaternion,fireEvent=function(){var eventData;return function(name){eventData=arguments||{},eventData.type=name,eventData.target=this,this.dispatchEvent(eventData)}.bind(this)}.bind(this)();this.constrainObjectFOV=function(){relativeFOVFrustrumHeight=startFOVFrustrumHeight*(window.innerHeight/startClientHeight),relativeVerticalFOV=THREE.Math.radToDeg(2*Math.atan(relativeFOVFrustrumHeight/2e3)),this.object.fov=relativeVerticalFOV}.bind(this),this.onDeviceOrientationChange=function(event){this.deviceOrientation=event}.bind(this),this.onScreenOrientationChange=function(){this.screenOrientation=window.orientation||0,fireEvent(CONTROLLER_EVENT.SCREEN_ORIENTATION)}.bind(this),this.onCompassNeedsCalibration=function(event){event.preventDefault(),fireEvent(CONTROLLER_EVENT.CALIBRATE_COMPASS)}.bind(this),this.onDocumentMouseDown=function(event){this.enableManualDrag===!0&&(event.preventDefault(),appState=CONTROLLER_STATE.MANUAL_ROTATE,this.freeze=!0,tmpQuat.copy(this.object.quaternion),startX=currentX=event.pageX,startY=currentY=event.pageY,scrollSpeedX=1200/window.innerWidth*.2,scrollSpeedY=800/window.innerHeight*.2,this.element.addEventListener("mousemove",this.onDocumentMouseMove,!1),document.addEventListener("mouseup",this.onDocumentMouseUp,!1),fireEvent(CONTROLLER_EVENT.MANUAL_CONTROL+"start"),fireEvent(CONTROLLER_EVENT.ROTATE_CONTROL+"start"))}.bind(this),this.onDocumentMouseMove=function(event){currentX=event.pageX,currentY=event.pageY}.bind(this),this.onDocumentMouseUp=function(event){this.element.removeEventListener("mousemove",this.onDocumentMouseMove,!1),document.removeEventListener("mouseup",this.onDocumentMouseUp,!1),appState=CONTROLLER_STATE.AUTO,this.freeze=!1,fireEvent(CONTROLLER_EVENT.MANUAL_CONTROL+"end"),fireEvent(CONTROLLER_EVENT.ROTATE_CONTROL+"end")}.bind(this),this.onDocumentTouchStart=function(event){switch(event.preventDefault(),event.stopPropagation(),event.touches.length){case 1:if(this.enableManualDrag!==!0)return;appState=CONTROLLER_STATE.MANUAL_ROTATE,this.freeze=!0,tmpQuat.copy(this.object.quaternion),startX=currentX=event.touches[0].pageX,startY=currentY=event.touches[0].pageY,scrollSpeedX=1200/window.innerWidth*.1,scrollSpeedY=800/window.innerHeight*.1,this.element.addEventListener("touchmove",this.onDocumentTouchMove,!1),this.element.addEventListener("touchend",this.onDocumentTouchEnd,!1),fireEvent(CONTROLLER_EVENT.MANUAL_CONTROL+"start"),fireEvent(CONTROLLER_EVENT.ROTATE_CONTROL+"start");break;case 2:if(this.enableManualZoom!==!0)return;appState=CONTROLLER_STATE.MANUAL_ZOOM,this.freeze=!0,tmpFOV=this.object.fov,zoomP1.set(event.touches[0].pageX,event.touches[0].pageY),zoomP2.set(event.touches[1].pageX,event.touches[1].pageY),zoomStart=zoomCurrent=zoomP1.distanceTo(zoomP2),this.element.addEventListener("touchmove",this.onDocumentTouchMove,!1),this.element.addEventListener("touchend",this.onDocumentTouchEnd,!1),fireEvent(CONTROLLER_EVENT.MANUAL_CONTROL+"start"),fireEvent(CONTROLLER_EVENT.ZOOM_CONTROL+"start")}}.bind(this),this.onDocumentTouchMove=function(event){switch(event.touches.length){case 1:currentX=event.touches[0].pageX,currentY=event.touches[0].pageY;break;case 2:zoomP1.set(event.touches[0].pageX,event.touches[0].pageY),zoomP2.set(event.touches[1].pageX,event.touches[1].pageY)}}.bind(this),this.onDocumentTouchEnd=function(event){this.element.removeEventListener("touchmove",this.onDocumentTouchMove,!1),this.element.removeEventListener("touchend",this.onDocumentTouchEnd,!1),appState===CONTROLLER_STATE.MANUAL_ROTATE?(appState=CONTROLLER_STATE.AUTO,this.freeze=!1,fireEvent(CONTROLLER_EVENT.MANUAL_CONTROL+"end"),fireEvent(CONTROLLER_EVENT.ROTATE_CONTROL+"end")):appState===CONTROLLER_STATE.MANUAL_ZOOM&&(this.constrainObjectFOV(),appState=CONTROLLER_STATE.AUTO,this.freeze=!1,fireEvent(CONTROLLER_EVENT.MANUAL_CONTROL+"end"),fireEvent(CONTROLLER_EVENT.ZOOM_CONTROL+"end"))}.bind(this);var createQuaternion=function(){var finalQuaternion=new THREE.Quaternion,deviceEuler=new THREE.Euler,screenTransform=new THREE.Quaternion,worldTransform=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),minusHalfAngle=0;return function(alpha,beta,gamma,screenOrientation){return deviceEuler.set(beta,alpha,-gamma,"YXZ"),finalQuaternion.setFromEuler(deviceEuler),minusHalfAngle=-screenOrientation/2,screenTransform.set(0,Math.sin(minusHalfAngle),0,Math.cos(minusHalfAngle)),finalQuaternion.multiply(screenTransform),finalQuaternion.multiply(worldTransform),finalQuaternion}}(),createRotationMatrix=function(){var finalMatrix=new THREE.Matrix4,deviceEuler=new THREE.Euler,screenEuler=new THREE.Euler,worldEuler=new THREE.Euler(-Math.PI/2,0,0,"YXZ"),screenTransform=new THREE.Matrix4,worldTransform=new THREE.Matrix4;return worldTransform.makeRotationFromEuler(worldEuler),function(alpha,beta,gamma,screenOrientation){return deviceEuler.set(beta,alpha,-gamma,"YXZ"),finalMatrix.identity(),finalMatrix.makeRotationFromEuler(deviceEuler),screenEuler.set(0,-screenOrientation,0,"YXZ"),screenTransform.identity(),screenTransform.makeRotationFromEuler(screenEuler),finalMatrix.multiply(screenTransform),finalMatrix.multiply(worldTransform),finalMatrix}}();this.updateManualMove=function(){var lat,lon,phi,theta,tmpZ,objZ,realZ,zoomFactor,rotation=new THREE.Euler(0,0,0,"YXZ"),rotQuat=new THREE.Quaternion,objQuat=new THREE.Quaternion,minZoomFactor=1;return function(){objQuat.copy(tmpQuat),appState===CONTROLLER_STATE.MANUAL_ROTATE?(lat=(startY-currentY)*scrollSpeedY,lon=(startX-currentX)*scrollSpeedX,options.naturalScrolling&&(lat=1===Math.sign(lat)?-Math.abs(lat):Math.abs(lat),lon=1===Math.sign(lon)?-Math.abs(lon):Math.abs(lon)),phi=THREE.Math.degToRad(lat),theta=THREE.Math.degToRad(lon),rotQuat.set(0,Math.sin(theta/2),0,Math.cos(theta/2)),objQuat.multiply(rotQuat),rotQuat.set(Math.sin(phi/2),0,0,Math.cos(phi/2)),objQuat.multiply(rotQuat),tmpZ=rotation.setFromQuaternion(tmpQuat,"YXZ").z,objZ=rotation.setFromQuaternion(objQuat,"YXZ").z,realZ=rotation.setFromQuaternion(deviceQuat||tmpQuat,"YXZ").z,rotQuat.set(0,0,Math.sin((realZ-tmpZ)/2),Math.cos((realZ-tmpZ)/2)),tmpQuat.multiply(rotQuat),rotQuat.set(0,0,Math.sin((realZ-objZ)/2),Math.cos((realZ-objZ)/2)),objQuat.multiply(rotQuat),this.object.quaternion.copy(objQuat)):appState===CONTROLLER_STATE.MANUAL_ZOOM&&(zoomCurrent=zoomP1.distanceTo(zoomP2),zoomFactor=zoomStart/zoomCurrent,minZoomFactor>=zoomFactor&&(this.object.fov=tmpFOV*zoomFactor,this.object.updateProjectionMatrix()),deviceQuat&&(tmpZ=rotation.setFromQuaternion(tmpQuat,"YXZ").z,realZ=rotation.setFromQuaternion(deviceQuat,"YXZ").z,rotQuat.set(0,0,Math.sin((realZ-tmpZ)/2),Math.cos((realZ-tmpZ)/2)),tmpQuat.multiply(rotQuat),this.object.quaternion.copy(tmpQuat)))}}(),this.updateDeviceMove=function(){var alpha,beta,gamma,orient,deviceMatrix;return function(){if(alpha=THREE.Math.degToRad(this.deviceOrientation.alpha||0),beta=THREE.Math.degToRad(this.deviceOrientation.beta||0),gamma=THREE.Math.degToRad(this.deviceOrientation.gamma||0),orient=THREE.Math.degToRad(this.screenOrientation||0),0!==alpha&&0!==beta&&0!==gamma){if(this.useQuaternions?deviceQuat=createQuaternion(alpha,beta,gamma,orient):(deviceMatrix=createRotationMatrix(alpha,beta,gamma,orient),deviceQuat.setFromRotationMatrix(deviceMatrix)),this.freeze)return;this.object.quaternion.copy(deviceQuat)}}}(),this.update=function(){this.updateDeviceMove(),appState!==CONTROLLER_STATE.AUTO&&this.updateManualMove()},this.connect=function(){window.addEventListener("resize",this.constrainObjectFOV,!1),window.addEventListener("orientationchange",this.onScreenOrientationChange,!1),window.addEventListener("deviceorientation",this.onDeviceOrientationChange,!1),window.addEventListener("compassneedscalibration",this.onCompassNeedsCalibration,!1),this.element.addEventListener("mousedown",this.onDocumentMouseDown,!1),this.element.addEventListener("touchstart",this.onDocumentTouchStart,!1),this.freeze=!1},this.disconnect=function(){this.freeze=!0,window.removeEventListener("resize",this.constrainObjectFOV,!1),window.removeEventListener("orientationchange",this.onScreenOrientationChange,!1),window.removeEventListener("deviceorientation",this.onDeviceOrientationChange,!1),window.removeEventListener("compassneedscalibration",this.onCompassNeedsCalibration,!1),this.element.removeEventListener("mousedown",this.onDocumentMouseDown,!1),this.element.removeEventListener("touchstart",this.onDocumentTouchStart,!1)}};DeviceOrientationController.prototype=Object.create(THREE.EventDispatcher.prototype);